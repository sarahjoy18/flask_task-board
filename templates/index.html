<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Task board - Kanban</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <style>
        * {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .sticky-note {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .sticky-note:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 12px 32px rgba(0, 0, 0, 0.1);
        }
        .sticky-yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .sticky-pink { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        .sticky-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .sticky-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .sticky-purple { background: linear-gradient(135deg, #ede9fe 0%, #e9d5ff 100%); }
        .sticky-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
        
        .kanban-column {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .column-header {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-bottom: 2px solid #0ea5e9;
        }
        
        .trello-column {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .header-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 3rem 0;
            border-radius: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .form-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(15, 23, 42, 0.06);
        }
        
        .form-section h3 {
            color: #1e293b;
        }
        
        input {
            background: white;
            border-color: #cbd5e1;
            color: #1e293b;
        }
        
        input::placeholder {
            color: #94a3b8;
        }
        
        input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        button {
            transition: all 0.2s ease;
        }
        
        button:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 12px rgba(14, 165, 233, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-success:active {
            transform: translateY(0);
        }
        
        .team-member-badge {
            cursor: move;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .team-member-badge:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .team-member-badge.dragging {
            opacity: 0.5;
        }
        
        .sticky-note.drag-over {
            border: 2px dashed #0ea5e9;
            background-color: rgba(14, 165, 233, 0.05) !important;
        }
        
        .assignee-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .assignee-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.5px;
        }
        
        .assignee-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
        }
        
        /* Team summary table styling */
        .team-summary-table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
        }
        .team-summary-table th, .team-summary-table td {
            padding: 0.5rem 0.6rem;
            text-align: left;
            font-size: 0.875rem;
            color: #0f172a;
        }
        .team-summary-table thead th {
            font-weight: 700;
            font-size: 0.78rem;
            color: #334155;
            padding-bottom: 0.6rem;
        }
        .team-summary-row {
            border-radius: 8px;
            transition: background 0.15s ease, transform 0.15s ease;
        }
        .team-summary-row:hover {
            background: rgba(2,6,23,0.03);
            transform: translateY(-2px);
        }
        .team-summary-row.dragging {
            opacity: 0.5;
        }
        .team-summary-count {
            display: inline-block;
            min-width: 28px;
            text-align: center;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            color: #fff;
            font-weight: 700;
            font-size: 0.78rem;
        }
    </style>
</head>
<body class="min-h-screen p-12">
    <div class="max-w-7xl mx-auto">
        <div class="header-section mb-8 text-center">
            <div>
                <h1 class="text-6xl font-bold text-white mb-2">üìå Task Board</h1>
                <p class="text-gray-300 text-lg">Drag and drop sticky notes to organize your tasks</p>
            </div>
        </div>

        <!-- Team Members & Add Task Section -->
        <div class="grid grid-cols-2 gap-6 mb-8 max-w-6xl mx-auto">
            <!-- Team Members Management -->
            <div class="form-section p-6">
                <h3 class="text-xl font-bold mb-4">üë• Team Members</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="teamMemberInput" placeholder="Add team member name..." 
                           class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none text-sm">
                    <button onclick="addTeamMember()" class="btn-success">
                        + Add
                    </button>
                </div>
                <div id="teamList" class="flex flex-wrap gap-2">
                    <!-- Team members will be displayed here -->
                </div>
            </div>

            <!-- Add Todo Form -->
            <div class="form-section p-6">
                <h3 class="text-xl font-bold mb-4">‚ûï Create Task</h3>
                <form id="todoForm" class="flex flex-col gap-3">
                    <input type="text" id="todoInput" placeholder="Task name..." 
                           class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none text-sm font-medium">
                    <div id="assigneeSelect" class="flex flex-wrap gap-2 max-h-20 overflow-y-auto">
                        <!-- Assignee checkboxes will be added here -->
                    </div>
                    <button type="submit" class="btn-primary">
                        ‚úì Add Task
                    </button>
                </form>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="grid grid-cols-3 gap-6 mt-12 h-full pb-8">
            <!-- To Do Column -->
            <div class="trello-column flex flex-col">
                <div class="column-header px-6 py-4 rounded-t-2xl text-center">
                    <h2 class="text-xl font-bold text-white">üìù To Do</h2>
                    <p class="text-xs text-gray-200 mt-1">Getting started</p>
                </div>
                <div id="todo-column" class="kanban-column flex-1 p-4 space-y-3 overflow-y-auto rounded-b-2xl" data-status="todo">
                    <!-- Sticky notes will be added here -->
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="trello-column flex flex-col">
                <div class="column-header px-6 py-4 rounded-t-2xl text-center">
                    <h2 class="text-xl font-bold text-white">‚ö° In Progress</h2>
                    <p class="text-xs text-gray-200 mt-1">Currently working</p>
                </div>
                <div id="in-progress-column" class="kanban-column flex-1 p-4 space-y-3 overflow-y-auto rounded-b-2xl" data-status="in_progress">
                    <!-- Sticky notes will be added here -->
                </div>
            </div>

            <!-- Done Column -->
            <div class="trello-column flex flex-col">
                <div class="column-header px-6 py-4 rounded-t-2xl text-center">
                    <h2 class="text-xl font-bold text-white">‚úÖ Done</h2>
                    <p class="text-xs text-gray-200 mt-1">All finished</p>
                </div>
                <div id="done-column" class="kanban-column flex-1 p-4 space-y-3 overflow-y-auto rounded-b-2xl" data-status="done">
                    <!-- Sticky notes will be added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const todoForm = document.getElementById('todoForm');
        const todoInput = document.getElementById('todoInput');
        const teamMemberInput = document.getElementById('teamMemberInput');
        const teamList = document.getElementById('teamList');
        const assigneeSelect = document.getElementById('assigneeSelect');
        const columns = document.querySelectorAll('.kanban-column');
        let team = [];

        // Load data on page load
        loadTeam();
        loadTodos();

        // Form submit
        todoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = todoInput.value.trim();
            if (!title) return;

            // Get selected assignees
            const assignees = Array.from(assigneeSelect.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.dataset.memberId));

            const response = await fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, assignees })
            });

            if (response.ok) {
                todoInput.value = '';
                assigneeSelect.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                loadTodos();
            }
        });

        async function loadTeam() {
            const response = await fetch('/api/team');
            team = await response.json();
            //await renderTeamList();
            renderAssigneeSelect();
        }

        async function renderTeamList() {
            teamList.innerHTML = '';
            // Build a table container
            const table = document.createElement('table');
            table.className = 'team-summary-table';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Member</th>
                    <th>To Do</th>
                    <th>In Progress</th>
                    <th>Done</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            for (const member of team) {
                const summary = await getTaskSummaryForMember(member.id);
                const tr = document.createElement('tr');
                tr.className = 'team-summary-row';
                tr.draggable = true;
                tr.dataset.memberId = member.id;

                tr.innerHTML = `
                    <td class="flex items-center gap-3">
                        <span style="width: 12px; height: 12px; background: ${member.color}; border-radius: 50%; display:inline-block;"></span>
                        <span class="font-semibold text-gray-800">${member.name}</span>
                    </td>
                    <td><span class="team-summary-count" style="background:#0ea5e9">${summary.todo}</span></td>
                    <td><span class="team-summary-count" style="background:#f59e0b">${summary.in_progress}</span></td>
                    <td><span class="team-summary-count" style="background:#10b981">${summary.done}</span></td>
                    <td><span class="team-summary-count" style="background:#6b7280">${summary.total}</span></td>
                    <td><button onclick="deleteTeamMember(${member.id})" class="text-red-500 hover:text-red-700 font-bold text-sm">√ó</button></td>
                `;

                // Drag handlers for table rows
                tr.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('memberId', member.id);
                    tr.classList.add('dragging');
                });

                tr.addEventListener('dragend', () => tr.classList.remove('dragging'));

                tbody.appendChild(tr);
            }

            table.appendChild(tbody);
            teamList.appendChild(table);
        }

        function renderAssigneeSelect() {
            assigneeSelect.innerHTML = '';
            team.forEach(member => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200';
                label.innerHTML = `
                    <input type="checkbox" data-member-id="${member.id}" class="w-4 h-4">
                    <span style="width: 10px; height: 10px; background: ${member.color}; border-radius: 50%;"></span>
                    <span class="text-sm font-semibold text-gray-700">${member.name}</span>
                `;
                assigneeSelect.appendChild(label);
            });
        }

        async function getTaskSummaryForMember(memberId) {
            try {
                const res = await fetch('/api/todos');
                const todos = await res.json();
                const summary = { todo: 0, in_progress: 0, done: 0 };
                todos.forEach(t => {
                    if (Array.isArray(t.assignees) && t.assignees.includes(memberId)) {
                        if (t.status === 'todo') summary.todo += 1;
                        else if (t.status === 'in_progress') summary.in_progress += 1;
                        else if (t.status === 'done') summary.done += 1;
                    }
                });
                summary.total = summary.todo + summary.in_progress + summary.done;
                return summary;
            } catch (err) {
                return { todo: 0, in_progress: 0, done: 0, total: 0 };
            }
        }

        async function addTeamMember() {
            const name = teamMemberInput.value.trim();
            if (!name) return;

            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe', '#43e97b', '#fa709a', '#feca57'];
            const color = colors[team.length % colors.length];

            const response = await fetch('/api/team', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, color })
            });

            if (response.ok) {
                teamMemberInput.value = '';
                loadTeam();
            }
        }

        async function deleteTeamMember(memberId) {
            await fetch(`/api/team/${memberId}`, { method: 'DELETE' });
            loadTeam();
        }

        // Drag and drop setup
        columns.forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('drop', handleDrop);
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.dropEffect = 'move';
            this.classList.add('bg-white', 'bg-opacity-20');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('bg-white', 'bg-opacity-20');
            
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = this.dataset.status;
            
            updateTaskStatus(parseInt(taskId), newStatus);
        }

        columns.forEach(column => {
            column.addEventListener('dragleave', function() {
                if (this === event.target) {
                    this.classList.remove('bg-white', 'bg-opacity-20');
                }
            });
        });

        async function loadTodos() {
            const response = await fetch('/api/todos');
            const todos = await response.json();

            // Clear all columns
            columns.forEach(col => col.innerHTML = '');

            // Group todos by status
            todos.forEach(todo => {
                const column = document.querySelector(`[data-status="${todo.status}"]`);
                if (column) {
                    const card = createTaskCard(todo);
                    column.appendChild(card);
                }
            });

            // Update team member task counts
            renderTeamList();
        }

        const noteColors = ['sticky-yellow', 'sticky-pink', 'sticky-blue', 'sticky-green', 'sticky-purple', 'sticky-orange'];
        
        function createTaskCard(todo) {
            const card = document.createElement('div');
            const colorClass = noteColors[todo.id % noteColors.length];
            card.className = `sticky-note ${colorClass} rounded-2xl p-5 shadow-lg cursor-move relative m-[5.5%] p-[5%]`;
            card.style.minHeight = '140px';
            card.draggable = true;
            card.dataset.taskId = todo.id;

            // Get assignee names
            const assigneeNames = (todo.assignees || []).map(id => {
                const member = team.find(m => m.id === id);
                return member ? member.name : '';
            }).filter(name => name);

            card.innerHTML = `
                <div class="flex flex-col justify-between h-full">
                    <div>
                        <h2 class="text-gray-800 font-bold text-base leading-relaxed break-words pr-6">${escapeHtml(todo.title)}</h2>
                        ${assigneeNames.length > 0 ? `
                            <div class="assignee-badges">
                                ${(todo.assignees || []).map(id => {
                                    const member = team.find(m => m.id === id);
                                    return member ? `<span class="assignee-badge" style="background: ${member.color};">${member.name}</span>` : '';
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-between items-end mt-4">
                        <span class="text-xs text-gray-700 font-semibold opacity-60">ID: ${todo.id}</span>
                        <button onclick="deleteTask(${todo.id})" class="text-gray-400 hover:text-red-500 hover:scale-125 transition" title="Delete task">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', todo.id);
                card.classList.add('opacity-50');
            });

            card.addEventListener('dragend', (e) => {
                card.classList.remove('opacity-50');
                card.classList.remove('drag-over');
            });

            // Drop handlers for assigning team members to tasks
            card.addEventListener('dragover', (e) => {
                if (e.dataTransfer.types.includes('memberId')) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    card.classList.add('drag-over');
                }
            });

            card.addEventListener('dragleave', (e) => {
                if (e.target === card) {
                    card.classList.remove('drag-over');
                }
            });

            card.addEventListener('drop', async (e) => {
                e.preventDefault();
                card.classList.remove('drag-over');
                const memberId = parseInt(e.dataTransfer.getData('memberId'));
                
                if (!memberId) return;
                
                // Get current todo and add member if not already assigned
                const todos = await (await fetch('/api/todos')).json();
                const currentTodo = todos.find(t => t.id === todo.id);
                const assignees = currentTodo.assignees || [];
                
                if (!assignees.includes(memberId)) {
                    assignees.push(memberId);
                    await fetch(`/api/todos/${todo.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            status: currentTodo.status,
                            assignees: assignees
                        })
                    });
                    loadTodos();
                }
            });

            return card;
        }

        async function updateTaskStatus(id, newStatus) {
            const todos = await (await fetch('/api/todos')).json();
            const todo = todos.find(t => t.id === id);
            
            await fetch(`/api/todos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    status: newStatus,
                    assignees: todo.assignees || []
                })
            });
            loadTodos();
        }

        async function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                await fetch(`/api/todos/${id}`, { method: 'DELETE' });
                loadTodos();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
